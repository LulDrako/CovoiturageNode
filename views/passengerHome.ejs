<%- include('partials/header', { user: user }) %>

<h1>Bienvenue, Passager !</h1>

<div class="search-container">
    <h2>Rechercher un trajet</h2>
    <form id="search-form">
        <input type="text" id="search-start" placeholder="Lieu de d√©part">
        <input type="text" id="search-end" placeholder="Lieu d'arriv√©e">
        <input type="date" id="search-date">
        <button type="submit">üîç Rechercher</button>
    </form>
</div>

<% if (trips.length === 0) { %>
    <p style="text-align: center; font-size: 18px; margin-top: 30px;">üöó Aucun trajet disponible pour le moment.</p>
<% } else { %>
    <div id="trips-list">
        <% trips.forEach(function(trip) { %>
            <div class="trip">
                <p><strong>Trajet:</strong> De <%= trip.startPoint %> √† <%= trip.endPoint %></p>
                <p><strong>Conducteur(ice) :</strong> <%= trip.driver ? trip.driver.username : "Nom inconnu" %></p>
                <div>
                    <% if (trip.car && trip.car.image) { %>
                        <img src="<%= trip.car.image %>" alt="Image de la voiture" style="max-width: 200px; max-height: 150px;">
                    <% } else { %>
                        <p>Image indisponible</p>
                    <% } %>
                </div>
                <p><strong>Voiture:</strong> <%= trip.car?.model || 'Mod√®le inconnu' %> (<%= trip.car?.plate || 'Plaque inconnue' %>)</p>
                <p><strong>D√©part:</strong> 
                    <%= new Date(trip.departureTime).toLocaleString('fr-FR', {
                        weekday: 'long',
                        day: '2-digit',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) %>
                </p>
                <% if (trip.arrivalTime) { %>
                    <p><strong>Heure d'arriv√©e estim√©e:</strong> 
                        <%= new Date(trip.arrivalTime).toLocaleString('fr-FR', {
                            weekday: 'long',
                            day: '2-digit',
                            month: 'long',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) %>
                    </p>
                <% } else { %>
                    <p><strong>Heure d'arriv√©e estim√©e:</strong> Non disponible</p>
                <% } %>
                <p><strong>Si√®ges disponibles:</strong> <%= trip.seatsAvailable %></p>
                <p><strong>Prix:</strong> <%= trip.price %> euros</p>
                <p><strong>Informations suppl√©mentaires:</strong> <%= trip.additionalInfo %></p>
                <p><strong>Dur√©e:</strong> <%= trip.duration.replace("hours", "heures").replace("mins", "minutes") %></p>
                <p><strong>Distance:</strong> <%= trip.distance %></p>
                <button onclick="reserveTrip('<%= trip._id %>')">R√©server</button>
            </div>
        <% }); %>
    </div>
<% } %>

<%- include('partials/footer') %>

<!-- SCRIPTS -->
<script>
    function reserveTrip(tripId) {
        fetch('/reserve-trip', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tripId })
        })
        .then(response => {
            if (response.ok) {
                window.location.href = `/payment?tripId=${tripId}`;
            } else {
                console.error('Erreur lors de la r√©servation');
            }
        })
        .catch(error => {
            console.error('Erreur lors de la r√©servation:', error);
        });
    }

    document.getElementById("search-form").addEventListener("submit", function (e) {
        e.preventDefault();
        const start = document.getElementById("search-start").value.toLowerCase();
        const end = document.getElementById("search-end").value.toLowerCase();
        const date = document.getElementById("search-date").value;

        const trips = document.querySelectorAll(".trip");
        trips.forEach(trip => {
            const tripText = trip.innerText.toLowerCase();
            const show = tripText.includes(start) && tripText.includes(end) && (!date || tripText.includes(date));
            trip.style.display = show ? "block" : "none";
        });
    });
</script>
